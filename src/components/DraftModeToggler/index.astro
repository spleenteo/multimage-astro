---
import { resolveDraftMode } from '~/lib/draftPreview';

const draftModeEnabled = resolveDraftMode(Astro);
const currentPath = Astro.url.pathname + Astro.url.search;
---

<draft-mode-toggler
  class="draft-mode-toggle"
  data-enabled={draftModeEnabled ? 'true' : 'false'}
  data-path={currentPath}
>
  <p class="draft-mode-toggle__label">
    {draftModeEnabled ? 'Anteprima attiva' : 'Anteprima disattivata'}
  </p>
  <button type="button" class="draft-mode-toggle__button">
    {draftModeEnabled ? 'Esci dalla bozza' : 'Entra in anteprima'}
  </button>
</draft-mode-toggler>

<style>
  .draft-mode-toggle {
    position: fixed;
    right: 1rem;
    bottom: 1rem;
    z-index: 50;
    padding: 0.75rem 1rem;
    border-radius: 999px;
    background: rgba(17, 24, 39, 0.85);
    color: #f8fafc;
    font-size: 0.875rem;
    font-weight: 500;
    box-shadow: 0 10px 15px rgba(15, 23, 42, 0.2);
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    max-width: 260px;
  }

  .draft-mode-toggle__label {
    margin: 0;
    line-height: 1.2;
  }

  .draft-mode-toggle__button {
    border: 1px solid rgba(248, 250, 252, 0.4);
    background: transparent;
    color: inherit;
    font-size: 0.8rem;
    border-radius: 999px;
    padding: 0.4rem 0.9rem;
    cursor: pointer;
  }

  @media (max-width: 768px) {
    .draft-mode-toggle {
      left: 1rem;
      right: 1rem;
      border-radius: 1rem;
    }
  }
</style>

<script>
  class DraftModeToggler extends HTMLElement {
    connectedCallback() {
      const button = this.querySelector('button');

      if (!button) {
        return;
      }

      button.addEventListener('click', () => this.handleClick());
    }

    get isDraftModeEnabled() {
      return this.dataset.enabled === 'true';
    }

    get currentPath() {
      return this.dataset.path || '/';
    }

    async handleClick() {
      let response;

      if (this.isDraftModeEnabled) {
        response = await fetch(
          `/api/draft-mode/disable?url=${encodeURIComponent(this.currentPath)}`,
        );
      } else {
        const secret = prompt(
          'Inserisci la chiave di anteprima privata per vedere le bozze:',
        )?.trim();

        if (!secret) {
          return;
        }

        response = await fetch(
          `/api/preview?secret=${encodeURIComponent(secret)}&redirect=${encodeURIComponent(this.currentPath)}`,
        );
      }

      if (!response?.ok) {
        alert('Impossibile aggiornare la modalit√† anteprima. Verifica la chiave e riprova.');
        return;
      }

      window.location.reload();
    }
  }

  customElements.define('draft-mode-toggler', DraftModeToggler);
</script>
