---
import { Image } from '@datocms/astro/Image';
import type { ResponsiveImage, AssetColor } from '~/lib/datocms/types';

type HighlightBookProps = {
  title: string;
  subtitle?: string | null;
  summary?: string | null;
  priceLabel?: string | null;
  format?: string | null;
  printYear?: string | null;
  isArchived?: boolean;
  link?: string | null;
  authorsLabel?: string | null;
};

type HighlightAuthorProps = {
  name: string;
  slug?: string | null;
  link?: string | null;
  booksCount?: number | null;
  picture?: ResponsiveImage | null;
  pictureAlt?: string | null;
};

type Props = {
  book: HighlightBookProps;
  coverImage?: ResponsiveImage | null;
  coverAlt?: string | null;
  collectionLabel?: string | null;
  collectionHref?: string | null;
  label?: string | null;
  author?: HighlightAuthorProps | null;
  coverColors?: AssetColor[] | null;
};

const {
  book,
  coverImage = null,
  coverAlt = 'Copertina',
  collectionLabel = null,
  collectionHref = null,
  label = 'In evidenza',
  author = null,
  coverColors = null,
}: Props = Astro.props;

const metaItems = [
  book.priceLabel ? `Prezzo ${book.priceLabel}` : null,
  book.format ? `Formato ${book.format}` : null,
  book.printYear ? `Anno ${book.printYear}` : null,
].filter((value): value is string => Boolean(value));

const metaLabel = metaItems.length > 0 ? metaItems.join(' Â· ') : null;

const authorLink = author?.link ?? (author?.slug ? `/autori/${author.slug}` : null);
const authorBooksCount = author?.booksCount ?? null;
const authorBooksLabel =
  authorBooksCount == null
    ? null
    : authorBooksCount === 0
      ? 'Nessun libro pubblicato'
      : authorBooksCount === 1
        ? '1 libro pubblicato'
        : `${authorBooksCount} libri pubblicati`;

const authorThumbnail = author?.picture ?? null;
const authorThumbnailAlt = author?.pictureAlt ?? author?.name ?? 'Ritratto autore';
const authorInitials =
  author?.name
    ?.split(/\s+/)
    .map((part) => part.charAt(0).toUpperCase())
    .join('')
    .slice(0, 2) ?? 'A';
const showArrow = Boolean(authorLink);
const coverImageData = coverImage
  ? { ...coverImage, alt: coverAlt ?? coverImage.alt ?? null }
  : null;
const authorImageData = authorThumbnail
  ? { ...authorThumbnail, alt: authorThumbnailAlt ?? authorThumbnail.alt ?? null }
  : null;
const authorCardClasses =
  'group inline-flex items-center gap-4 rounded-full bg-white/90 px-4 py-3 shadow-soft ring-1 ring-brand-navy/10 transition hover:-translate-y-0.5 hover:shadow-lg focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-sky focus-visible:ring-offset-2';

function pickBaseColor(colors: AssetColor[] | null | undefined) {
  if (!colors || colors.length === 0) {
    return '#E8EEF5';
  }
  const source = colors.slice(0, 3).find((color) => color?.hex) ?? colors[0];
  return source?.hex ?? '#E8EEF5';
}

function clamp(amount: number, min = 0, max = 1) {
  return Math.min(Math.max(amount, min), max);
}

function lightenColor(hex: string, amount = 0.18) {
  if (!/^#?[0-9A-Fa-f]{6}$/.test(hex)) {
    return '#F5F7FA';
  }
  const normalized = hex.startsWith('#') ? hex.slice(1) : hex;
  const num = Number.parseInt(normalized, 16);
  const r = (num >> 16) & 0xff;
  const g = (num >> 8) & 0xff;
  const b = num & 0xff;
  const blend = (component: number) => Math.round(component + (255 - component) * clamp(amount));
  const newR = blend(r).toString(16).padStart(2, '0');
  const newG = blend(g).toString(16).padStart(2, '0');
  const newB = blend(b).toString(16).padStart(2, '0');
  return `#${newR}${newG}${newB}`;
}

function darkenColor(hex: string, amount = 0.35) {
  if (!/^#?[0-9A-Fa-f]{6}$/.test(hex)) {
    return '#041C43';
  }
  const normalized = hex.startsWith('#') ? hex.slice(1) : hex;
  const num = Number.parseInt(normalized, 16);
  const r = (num >> 16) & 0xff;
  const g = (num >> 8) & 0xff;
  const b = num & 0xff;
  const blend = (component: number) => Math.round(component * (1 - clamp(amount)));
  const newR = blend(r).toString(16).padStart(2, '0');
  const newG = blend(g).toString(16).padStart(2, '0');
  const newB = blend(b).toString(16).padStart(2, '0');
  return `#${newR}${newG}${newB}`;
}

function hexToRgba(hex: string, alpha = 1) {
  if (!/^#?[0-9A-Fa-f]{6}$/.test(hex)) {
    return `rgba(4, 28, 67, ${alpha})`;
  }
  const normalized = hex.startsWith('#') ? hex.slice(1) : hex;
  const num = Number.parseInt(normalized, 16);
  const r = (num >> 16) & 0xff;
  const g = (num >> 8) & 0xff;
  const b = num & 0xff;
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

const baseColor = pickBaseColor(coverColors);
const backdropColor = lightenColor(baseColor, 0.16);
const shadowColor = hexToRgba(darkenColor(baseColor, 0.45), 0.45);
---

<section class="rounded-3xl border border-white/70 bg-white/95 shadow-soft">
  <div class="flex flex-col overflow-hidden md:flex-row">
    <div class="md:w-[38%] md:max-w-md">
      <div
        class="flex h-full items-center justify-center p-12 md:p-14"
        style={`background: ${backdropColor};`}
      >
        {
          coverImageData ? (
            <div class="relative flex items-center justify-center">
              <Image
                data={coverImageData}
                sizes="(min-width: 1280px) 320px, (min-width: 1024px) 260px, 70vw"
                pictureClass="block h-full w-full"
                imgClass="relative z-10 h-72 w-auto max-w-[260px] object-contain"
                imgStyle={{
                  transform: 'rotate(5deg)',
                  filter: `drop-shadow(24px 36px 48px ${shadowColor})`,
                }}
              />
            </div>
          ) : (
            <div class="flex min-h-[280px] items-center justify-center px-6 text-center text-sm font-semibold uppercase tracking-[0.2em] text-brand-slate">
              Copertina in arrivo
            </div>
          )
        }
      </div>
    </div>
    <div class="flex flex-1 flex-col gap-6 px-6 py-8 md:px-10 md:py-12">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div
          class="flex flex-wrap items-center gap-3 text-xs font-semibold uppercase tracking-[0.3em] text-brand-slate"
        >
          <span
            class="inline-flex items-center rounded-full bg-brand-navy px-4 py-1 text-white shadow-soft"
          >
            {label}
          </span>
          {
            collectionHref ? (
              <a
                href={collectionHref}
                class="inline-flex items-center gap-2 rounded-full bg-brand-mist/70 px-4 py-1 text-brand-navy transition hover:bg-brand-mist hover:text-brand-sky"
              >
                <iconify-icon
                  icon="iconoir:bookmark-book"
                  width="16"
                  height="16"
                  aria-hidden="true"
                />
                <span>{collectionLabel}</span>
              </a>
            ) : collectionLabel ? (
              <span class="inline-flex items-center rounded-full bg-brand-mist/70 px-4 py-1 text-brand-charcoal">
                {collectionLabel}
              </span>
            ) : null
          }
        </div>
        {
          book.isArchived ? (
            <span class="inline-flex items-center rounded-full bg-brand-slate px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.3em] text-white shadow-soft">
              Fuori catalogo
            </span>
          ) : null
        }
      </div>

      <div class="space-y-2 text-left">
        <h2 class="text-3xl font-serif text-brand-navy md:text-4xl">{book.title}</h2>
        {
          book.subtitle ? (
            <p class="text-lg font-medium text-brand-charcoal/80">{book.subtitle}</p>
          ) : null
        }
        {
          book.authorsLabel ? (
            <p class="text-sm font-semibold uppercase tracking-wide text-brand-charcoal/80">
              {book.authorsLabel}
            </p>
          ) : null
        }
      </div>

      {
        book.summary ? (
          <p class="text-base leading-relaxed text-brand-charcoal/80">{book.summary}</p>
        ) : null
      }

      {
        metaLabel ? (
          <p class="text-sm font-semibold uppercase tracking-wide text-brand-charcoal/70">
            {metaLabel}
          </p>
        ) : null
      }

      <div class="flex flex-wrap items-center gap-3 pt-2">
        {
          book.link ? (
            <a href={book.link} class="btn-primary">
              Scopri il libro
            </a>
          ) : null
        }
        {
          collectionHref ? (
            <a
              href={collectionHref}
              class="inline-flex items-center gap-2 border border-brand-navy px-5 py-2 text-xs font-semibold uppercase tracking-widest text-brand-navy transition hover:bg-brand-navy hover:text-white"
            >
              <span>Vai alla collana</span>
              <iconify-icon
                icon="iconoir:nav-arrow-right"
                width="16"
                height="16"
                aria-hidden="true"
              />
            </a>
          ) : null
        }
      </div>

      {
        author ? (
          <div class="mt-auto flex justify-end">
            {authorLink ? (
              <a href={authorLink} class={authorCardClasses}>
                <div class="relative h-16 w-16 overflow-hidden rounded-full ring-4 ring-white/80 shadow-soft">
                  {authorImageData ? (
                    <Image
                      data={authorImageData}
                      sizes="80px"
                      pictureClass="block h-full w-full"
                      imgClass="h-full w-full object-cover"
                      imgStyle={{ objectFit: 'cover', width: '100%', height: '100%' }}
                    />
                  ) : (
                    <div class="flex h-full w-full items-center justify-center bg-brand-mist text-lg font-semibold text-brand-navy">
                      {authorInitials}
                    </div>
                  )}
                </div>
                <div class="text-left">
                  <p class="text-xs font-semibold uppercase tracking-[0.3em] text-brand-slate">
                    Autore
                  </p>
                  <p class="text-lg font-serif text-brand-navy transition group-hover:text-brand-sky">
                    {author?.name ?? 'Autore in evidenza'}
                  </p>
                  {authorBooksLabel ? (
                    <p class="text-xs font-medium uppercase tracking-wide text-brand-charcoal/70">
                      {authorBooksLabel}
                    </p>
                  ) : null}
                </div>
                {showArrow ? (
                  <iconify-icon
                    icon="iconoir:nav-arrow-right"
                    width="20"
                    height="20"
                    aria-hidden="true"
                    class="text-brand-navy/70 transition group-hover:text-brand-navy"
                  />
                ) : null}
              </a>
            ) : (
              <div class={authorCardClasses}>
                <div class="relative h-16 w-16 overflow-hidden rounded-full ring-4 ring-white/80 shadow-soft">
                  {authorImageData ? (
                    <Image
                      data={authorImageData}
                      sizes="80px"
                      pictureClass="block h-full w-full"
                      imgClass="h-full w-full object-cover"
                      imgStyle={{ objectFit: 'cover', width: '100%', height: '100%' }}
                    />
                  ) : (
                    <div class="flex h-full w-full items-center justify-center bg-brand-mist text-lg font-semibold text-brand-navy">
                      {authorInitials}
                    </div>
                  )}
                </div>
                <div class="text-left">
                  <p class="text-xs font-semibold uppercase tracking-[0.3em] text-brand-slate">
                    Autore
                  </p>
                  <p class="text-lg font-serif text-brand-navy">
                    {author?.name ?? 'Autore in evidenza'}
                  </p>
                  {authorBooksLabel ? (
                    <p class="text-xs font-medium uppercase tracking-wide text-brand-charcoal/70">
                      {authorBooksLabel}
                    </p>
                  ) : null}
                </div>
              </div>
            )}
          </div>
        ) : null
      }
    </div>
  </div>
</section>
