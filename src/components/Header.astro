---
import BooksSectionNav from './BooksSectionNav.astro';

type NavLink = {
  label: string;
  href?: string;
  external?: boolean;
  children?: Array<{ label: string; href: string; external?: boolean }>;
};

type Props = {
  currentPath: string;
  infoPages?: Array<{
    id: string;
    label: string;
    href: string;
  }>;
};

type TopLink = {
  label: string;
  href: string;
  icon: string;
  external?: boolean;
  tone?: string;
};

const TOP_LINKS: TopLink[] = [
  {
    label: 'Instagram',
    href: 'https://www.instagram.com/multimage_editrice/',
    icon: 'iconoir:instagram',
    external: true,
    tone: 'instagram',
  },
  {
    label: 'Twitter',
    href: 'https://twitter.com/multimageED',
    icon: 'iconoir:twitter',
    external: true,
    tone: 'twitter',
  },
  {
    label: 'Facebook',
    href: 'https://www.facebook.com/multimage/',
    icon: 'iconoir:facebook-tag',
    external: true,
    tone: 'facebook',
  },
  {
    label: 'Newsletter',
    href: 'https://multimage.us2.list-manage.com/subscribe?u=2e642198d3dca9633e51d015a&id=ff885584a7',
    icon: 'iconoir:mail',
    external: true,
    tone: 'newsletter',
  },
  {
    label: 'Diventa socio',
    href: '/info/adesioni',
    icon: 'iconoir:pen',
    tone: 'cta',
  },
] as const;

function buildPrimaryLinks(infoPages: Array<{ label: string; href: string }>): NavLink[] {
  const infoChildren = infoPages.length > 0 ? infoPages : [];

  return [
    {
      label: 'Libri',
      children: [
        { label: 'Collane', href: '/collane' },
        { label: 'In evidenza', href: '/libri/highlights' },
        { label: 'Catalogo', href: '/libri' },
        { label: 'Ebooks', href: '/libri/ebooks' },
        { label: 'Fuori catalogo', href: '/libri/archivio' },
      ],
    },
    { label: 'Autrici/Autori', href: '/autori' },
    { label: 'Distributori', href: '/distributori' },
    { label: 'Magazine', href: '/magazine' },
    {
      label: 'Informazioni',
      children: infoChildren.map((page) => ({
        label: page.label,
        href: page.href,
      })),
    },
  ];
}

const toneClassMap: Record<string, string> = {
  instagram: 'bg-social-instagram hover:bg-social-instagram/80 text-white',
  twitter: 'bg-social-twitter hover:bg-social-twitter/80 text-white',
  facebook: 'bg-social-facebook hover:bg-social-facebook/80 text-white',
  newsletter: 'bg-social-newsletter hover:bg-social-newsletter/80 text-white',
  cta: 'bg-brand-orange hover:bg-brand-crimson text-white',
};

const socialBaseClass =
  'inline-flex items-center gap-2 px-4 py-2 text-[0.65rem] font-semibold uppercase tracking-wider transition';

const { currentPath, infoPages = [] }: Props = Astro.props;
const PRIMARY_LINKS = buildPrimaryLinks(infoPages);

const normalizedPath =
  currentPath.endsWith('/') && currentPath !== '/' ? currentPath.slice(0, -1) : currentPath;

const tabSlugCounts = new Map<string, number>();

function buildTabIds(label: string) {
  const base =
    label
      .toLowerCase()
      .replace(/[^a-z0-9]+/gi, '-')
      .replace(/(^-|-$)/g, '') || 'voce';
  const count = tabSlugCounts.get(base) ?? 0;
  tabSlugCounts.set(base, count + 1);
  const suffix = count > 0 ? `-${count}` : '';
  const id = `${base}${suffix}`;
  return {
    tabId: `primary-tab-${id}`,
    panelId: `primary-panel-${id}`,
  };
}

function linkIsActive(link: NavLink, pathname: string) {
  if (link.children && link.children.length > 0) {
    if (link.label === 'Libri') {
      return (
        pathname.startsWith('/libri') || pathname.startsWith('/collane') || pathname === '/collane'
      );
    }

    if (link.label === 'Magazine') {
      return pathname.startsWith('/magazine');
    }

    if (link.label === 'Informazioni') {
      return pathname.startsWith('/info');
    }

    return link.children.some((child) => pathname.startsWith(child.href));
  }

  if (!link.href) {
    return false;
  }

  if (link.href === '/') {
    return pathname === '/';
  }

  return pathname === link.href || pathname.startsWith(`${link.href}/`);
}

const showBooksNav = normalizedPath.startsWith('/libri') || normalizedPath.startsWith('/collane');
const year = new Date().getFullYear();
---

<header class="relative z-40 shadow-soft" data-header>
  <div class="hidden bg-brand-navy text-white md:block">
    <div
      class="container flex flex-wrap items-center justify-end gap-2 py-2 text-[0.65rem] font-semibold uppercase tracking-wider"
    >
      {
        TOP_LINKS.map(({ label, href, icon, external, tone }) => (
          <a
            href={href}
            target={external ? '_blank' : undefined}
            rel={external ? 'noreferrer' : undefined}
            class={`${socialBaseClass} ${tone ? toneClassMap[tone] : 'bg-brand-navy-light/40 hover:bg-brand-navy-light text-white'}`}
          >
            <iconify-icon icon={icon} width="16" height="16" aria-hidden="true" />
            <span>{label}</span>
          </a>
        ))
      }
    </div>
  </div>

  <div class="relative bg-brand-navy-light text-white">
    <div class="container flex items-center justify-between gap-4 py-6">
      <a href="/" class="flex flex-col items-start gap-2 md:flex-row md:items-center md:gap-4">
        <span class="relative block h-12 w-40">
          <img
            src="https://multimage.org/images/logo--white-f2946119.png"
            alt="Multimage"
            class="h-full w-full object-contain"
            loading="lazy"
          />
        </span>
      </a>

      <form data-search-form class="hidden items-center bg-white/10 pl-4 pr-1 text-sm md:flex">
        <iconify-icon
          icon="iconoir:search"
          width="16"
          height="16"
          class="text-white/80"
          aria-hidden="true"></iconify-icon>
        <input
          type="search"
          class="w-full bg-transparent px-2 py-2 text-white placeholder:text-white/60 focus:outline-none"
          placeholder="Cerca libri, autori..."
          aria-label="Cerca libri o autori"
        />
        <button
          type="submit"
          class="bg-white/20 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:bg-white/30"
        >
          Cerca
        </button>
      </form>

      <button
        type="button"
        class="flex items-center gap-2 border border-white/40 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:bg-white/10 md:hidden"
        aria-expanded="false"
        aria-controls="mobile-menu"
        data-menu-button
      >
        <iconify-icon
          icon="iconoir:menu"
          width="18"
          height="18"
          aria-hidden="true"
          data-menu-icon="closed"></iconify-icon>
        <iconify-icon
          icon="iconoir:cancel"
          width="18"
          height="18"
          aria-hidden="true"
          data-menu-icon="open"
          hidden></iconify-icon>
        <span class="text-xs font-semibold uppercase tracking-widest">Menu</span>
      </button>
    </div>

    <nav
      class="hidden border-t border-brand-navy/50 bg-brand-navy text-brand-sand md:block"
      aria-label="Navigazione principale"
    >
      <div
        class="container flex flex-wrap items-center gap-2 py-3 md:justify-end md:gap-4"
        role="tablist"
        aria-label="Sezioni principali del sito"
        data-tablist
      >
        {
          PRIMARY_LINKS.map((link) => {
            const isActive = linkIsActive(link, normalizedPath);
            const hasChildren = Boolean(link.children && link.children.length > 0);
            const { tabId, panelId } = buildTabIds(link.label);

            if (hasChildren) {
              return (
                <div class="relative flex flex-col items-stretch" data-tab-item>
                  <button
                    id={tabId}
                    type="button"
                    role="tab"
                    aria-controls={panelId}
                    aria-selected={isActive ? 'true' : 'false'}
                    aria-expanded="false"
                    aria-haspopup="true"
                    class={`group flex items-center gap-2 rounded-full border border-white/10 px-4 py-2 text-sm font-semibold uppercase tracking-[0.12em] transition focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-sky ${
                      isActive
                        ? 'bg-white text-brand-navy focus:text-brand-navy'
                        : 'bg-brand-navy/95 text-white hover:bg-brand-navy-light/90 focus:text-white'
                    }`}
                    data-tab-trigger
                    data-tab-target={panelId}
                    data-has-panel="true"
                    data-tab-initial={isActive ? 'true' : undefined}
                  >
                    <span>{link.label}</span>
                    <iconify-icon
                      icon="iconoir:nav-arrow-down"
                      width="16"
                      height="16"
                      aria-hidden="true"
                    />
                  </button>
                  <div
                    id={panelId}
                    role="tabpanel"
                    tabindex="-1"
                    aria-labelledby={tabId}
                    aria-hidden="true"
                    class="mt-2 hidden rounded-2xl border border-brand-navy/40 bg-brand-navy text-white shadow-2xl focus:outline-none md:absolute md:left-1/2 md:top-full md:z-30 md:mt-3 md:w-64 md:-translate-x-1/2"
                    data-tab-panel
                    data-tab-parent={tabId}
                  >
                    <p class="sr-only" id={`${panelId}-desc`}>
                      Seleziona un collegamento per visitare la sezione {link.label}.
                    </p>
                    <ul
                      class="flex flex-col divide-y divide-white/10 py-3"
                      aria-describedby={`${panelId}-desc`}
                    >
                      {link.children?.map((child) => (
                        <li>
                          <a
                            href={child.href}
                            class="flex items-center justify-between px-4 py-2 text-sm font-semibold text-white transition hover:bg-brand-navy-light/80 hover:text-white focus:bg-brand-navy-light/80 focus:text-white focus:outline-none"
                          >
                            <span>{child.label}</span>
                            <iconify-icon
                              icon="iconoir:nav-arrow-right"
                              width="16"
                              height="16"
                              aria-hidden="true"
                              class="text-white/80"
                            />
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              );
            }

            return (
              <a
                id={tabId}
                href={link.href ?? '#'}
                role="tab"
                aria-selected={isActive ? 'true' : 'false'}
                class={`rounded-full border border-white/10 px-4 py-2 text-sm font-semibold uppercase tracking-[0.12em] transition focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-sky ${
                  isActive
                    ? 'bg-white text-brand-navy focus:text-brand-navy'
                    : 'bg-brand-navy/95 text-white hover:bg-brand-navy-light/90 hover:text-white focus:text-white'
                }`}
                data-tab-trigger
                data-tab-link="true"
                data-tab-initial={isActive ? 'true' : undefined}
              >
                {link.label}
              </a>
            );
          })
        }
      </div>
    </nav>

    <div
      class="fixed inset-0 z-50 hidden bg-brand-navy/95 backdrop-blur-sm md:hidden"
      role="dialog"
      aria-modal="true"
      id="mobile-menu"
      data-mobile-menu
    >
      <div class="flex h-full flex-col justify-between px-6 py-6 text-white">
        <div class="space-y-6 overflow-auto">
          <div class="flex items-center justify-between">
            <span class="text-sm font-semibold uppercase tracking-[0.3em]">Menu</span>
            <button
              type="button"
              class="flex items-center gap-2 border border-white/40 px-3 py-2 text-xs uppercase tracking-widest text-white"
              data-close-menu
            >
              <iconify-icon icon="iconoir:cancel" width="16" height="16" aria-hidden="true"
              ></iconify-icon>
              <span>Chiudi</span>
            </button>
          </div>

          <nav class="space-y-4" aria-label="Navigazione mobile">
            <ul class="space-y-4 text-sm font-semibold uppercase tracking-[0.12em]">
              {
                PRIMARY_LINKS.map((link) => {
                  const hasChildren = Boolean(link.children && link.children.length > 0);
                  const isActive = linkIsActive(link, normalizedPath);

                  return (
                    <li data-mobile-accordion>
                      {hasChildren ? (
                        <>
                          <button
                            type="button"
                            class={`flex w-full items-center justify-between bg-white/10 px-4 py-3 text-left ${
                              isActive ? 'text-white' : 'text-white/90'
                            }`}
                            aria-expanded="false"
                            data-accordion-trigger
                          >
                            <span>{link.label}</span>
                            <iconify-icon
                              icon="iconoir:nav-arrow-down"
                              width="16"
                              height="16"
                              aria-hidden="true"
                            />
                          </button>
                          <div
                            class="hidden space-y-2 pl-4 text-xs tracking-[0.2em]"
                            data-accordion-panel
                          >
                            {link.children?.map((child) => (
                              <a
                                href={child.href}
                                class="block px-2 py-2 text-white/80 transition hover:text-white"
                                data-mobile-nav-target
                              >
                                {child.label}
                              </a>
                            ))}
                          </div>
                        </>
                      ) : (
                        <a
                          href={link.href ?? '#'}
                          class={`block bg-white/10 px-4 py-3 ${isActive ? 'text-white' : 'text-white/90'}`}
                          data-mobile-nav-target
                        >
                          {link.label}
                        </a>
                      )}
                    </li>
                  );
                })
              }
            </ul>
          </nav>

          <form data-search-form class="flex items-center bg-white/10 pl-4 pr-1 text-sm">
            <iconify-icon
              icon="iconoir:search"
              width="16"
              height="16"
              class="text-white/80"
              aria-hidden="true"></iconify-icon>
            <input
              type="search"
              class="w-full bg-transparent px-2 py-2 text-white placeholder:text-white/60 focus:outline-none"
              placeholder="Cerca libri, autori..."
              aria-label="Cerca libri o autori"
            />
            <button
              type="submit"
              class="bg-white/20 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:bg-white/30"
            >
              Cerca
            </button>
          </form>

          <div class="space-y-3">
            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-white/70">Seguici</p>
            <div class="flex flex-col gap-3">
              {
                TOP_LINKS.map(({ label, href, icon, external, tone }) => (
                  <a
                    href={href}
                    target={external ? '_blank' : undefined}
                    rel={external ? 'noreferrer' : undefined}
                    class={`flex items-center gap-3 px-4 py-3 text-xs uppercase tracking-[0.25em] ${
                      tone ? toneClassMap[tone] : 'bg-white/10'
                    }`}
                    data-mobile-nav-target
                  >
                    <iconify-icon icon={icon} width="16" height="16" aria-hidden="true" />
                    <span>{label}</span>
                  </a>
                ))
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {
    showBooksNav ? (
      <div class="border-t border-white/60 bg-white/80 py-4">
        <div class="container">
          <BooksSectionNav currentPath={normalizedPath} />
        </div>
      </div>
    ) : null
  }
</header>

<script type="module" is:inline>
  const header = document.querySelector('[data-header]');
  if (header) {
    const body = document.body;
    const menuButton = header.querySelector('[data-menu-button]');
    const mobileMenu = header.querySelector('[data-mobile-menu]');
    const closeMenuButtons = header.querySelectorAll('[data-close-menu]');
    const searchForms = header.querySelectorAll('form[data-search-form]');
    const accordionItems = header.querySelectorAll('[data-mobile-accordion]');
    const mq = window.matchMedia('(min-width: 768px)');
    const tabList = header.querySelector('[data-tablist]');
    const tabTriggers = tabList ? Array.from(tabList.querySelectorAll('[data-tab-trigger]')) : [];
    const tabPanels = tabList ? Array.from(header.querySelectorAll('[data-tab-panel]')) : [];
    const initialTab =
      tabTriggers.find((trigger) => trigger.dataset.tabInitial === 'true') ??
      tabTriggers[0] ??
      null;

    const setSelectedTab = (trigger) => {
      tabTriggers.forEach((item) => {
        item.setAttribute('aria-selected', item === trigger ? 'true' : 'false');
      });
    };

    const resetTabState = () => {
      if (!tabList) {
        return;
      }
      if (initialTab) {
        setSelectedTab(initialTab);
      }
      tabTriggers.forEach((item) => {
        if (item.dataset.hasPanel === 'true') {
          item.setAttribute('aria-expanded', 'false');
        }
      });
      tabPanels.forEach((panel) => {
        panel.classList.add('hidden');
        panel.setAttribute('aria-hidden', 'true');
      });
    };

    const openPanelFor = (trigger, { focusPanel = false } = {}) => {
      if (!tabList || !trigger) {
        return;
      }

      setSelectedTab(trigger);

      const targetId = trigger.dataset.tabTarget;
      const hasPanel = trigger.dataset.hasPanel === 'true' && targetId;

      tabTriggers.forEach((item) => {
        if (item.dataset.hasPanel === 'true') {
          item.setAttribute('aria-expanded', item === trigger && hasPanel ? 'true' : 'false');
        }
      });

      tabPanels.forEach((panel) => {
        const shouldShow = hasPanel && panel.id === targetId;
        panel.classList.toggle('hidden', !shouldShow);
        panel.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
        if (shouldShow && focusPanel) {
          panel.focus();
        }
      });
    };

    resetTabState();

    if (tabList && tabTriggers.length > 0) {
      tabTriggers.forEach((trigger) => {
        const hasPanel = trigger.dataset.hasPanel === 'true';

        trigger.addEventListener('focus', () => {
          if (hasPanel) {
            openPanelFor(trigger);
          } else {
            setSelectedTab(trigger);
          }
        });

        trigger.addEventListener('mouseenter', () => {
          if (hasPanel) {
            openPanelFor(trigger);
          } else {
            setSelectedTab(trigger);
          }
        });

        if (hasPanel) {
          trigger.addEventListener('click', (event) => {
            event.preventDefault();
            const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
            if (isExpanded) {
              resetTabState();
            } else {
              openPanelFor(trigger, { focusPanel: true });
            }
          });
        }
      });

      tabList.addEventListener('keydown', (event) => {
        if (!['ArrowRight', 'ArrowLeft', 'Home', 'End'].includes(event.key)) {
          return;
        }
        const currentIndex = tabTriggers.indexOf(document.activeElement);
        if (currentIndex === -1) {
          return;
        }
        event.preventDefault();
        let nextIndex = currentIndex;
        if (event.key === 'ArrowRight') {
          nextIndex = (currentIndex + 1) % tabTriggers.length;
        } else if (event.key === 'ArrowLeft') {
          nextIndex = (currentIndex - 1 + tabTriggers.length) % tabTriggers.length;
        } else if (event.key === 'Home') {
          nextIndex = 0;
        } else if (event.key === 'End') {
          nextIndex = tabTriggers.length - 1;
        }

        const nextTrigger = tabTriggers[nextIndex];
        if (nextTrigger) {
          nextTrigger.focus();
          if (nextTrigger.dataset.hasPanel === 'true') {
            openPanelFor(nextTrigger);
          } else {
            setSelectedTab(nextTrigger);
          }
        }
      });

      tabList.addEventListener('focusout', (event) => {
        if (!tabList.contains(event.relatedTarget)) {
          resetTabState();
        }
      });

      tabList.addEventListener('mouseleave', () => {
        resetTabState();
      });

      tabPanels.forEach((panel) => {
        const parentId = panel.dataset.tabParent;
        const parentTrigger = parentId ? header.querySelector(`#${parentId}`) : null;
        if (!parentTrigger) {
          return;
        }

        panel.addEventListener('mouseenter', () => {
          openPanelFor(parentTrigger);
        });

        panel.addEventListener('focusin', () => {
          openPanelFor(parentTrigger);
        });

        panel.addEventListener('mouseleave', () => {
          resetTabState();
        });

        panel.addEventListener('focusout', (event) => {
          if (!panel.contains(event.relatedTarget)) {
            resetTabState();
          }
        });
      });
    }

    const openIcon = header.querySelector('[data-menu-icon="open"]');
    const closedIcon = header.querySelector('[data-menu-icon="closed"]');

    const updateIcons = (open) => {
      if (openIcon && closedIcon) {
        if (open) {
          openIcon.removeAttribute('hidden');
          closedIcon.setAttribute('hidden', '');
        } else {
          closedIcon.removeAttribute('hidden');
          openIcon.setAttribute('hidden', '');
        }
      }
    };

    const lockScroll = () => {
      body.style.overflow = 'hidden';
    };

    const unlockScroll = () => {
      body.style.removeProperty('overflow');
    };

    const openMenu = () => {
      if (!mobileMenu || !menuButton) return;
      mobileMenu.classList.remove('hidden');
      menuButton.setAttribute('aria-expanded', 'true');
      updateIcons(true);
      lockScroll();
    };

    const closeMenu = () => {
      if (!mobileMenu || !menuButton) return;
      mobileMenu.classList.add('hidden');
      menuButton.setAttribute('aria-expanded', 'false');
      updateIcons(false);
      unlockScroll();
      accordionItems.forEach((item) => {
        const trigger = item.querySelector('[data-accordion-trigger]');
        const panel = item.querySelector('[data-accordion-panel]');
        if (trigger && panel) {
          trigger.setAttribute('aria-expanded', 'false');
          panel.classList.add('hidden');
        }
      });
    };

    menuButton?.addEventListener('click', () => {
      if (!mobileMenu) {
        return;
      }
      const isHidden = mobileMenu.classList.contains('hidden');
      if (isHidden) {
        openMenu();
      } else {
        closeMenu();
      }
    });

    closeMenuButtons.forEach((button) => {
      button.addEventListener('click', () => {
        closeMenu();
      });
    });

    mobileMenu?.addEventListener('click', (event) => {
      if (event.target === mobileMenu) {
        closeMenu();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeMenu();
        resetTabState();
      }
    });

    mq.addEventListener('change', (event) => {
      if (event.matches) {
        closeMenu();
      }
    });

    accordionItems.forEach((item) => {
      const trigger = item.querySelector('[data-accordion-trigger]');
      const panel = item.querySelector('[data-accordion-panel]');
      if (!trigger || !panel) {
        return;
      }

      trigger.addEventListener('click', () => {
        const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
        trigger.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
        panel.classList.toggle('hidden', isExpanded);
      });
    });

    const buildSearchUrl = (query) => {
      const normalized = query.trim();
      if (!normalized) {
        return null;
      }
      const siteQuery = `${normalized} site:multimage.org`;
      return `https://www.google.com/search?q=${encodeURIComponent(siteQuery)}`;
    };

    searchForms.forEach((form) => {
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const input = form.querySelector('input[type="search"]');
        if (!input) {
          return;
        }
        const url = buildSearchUrl(input.value ?? '');
        if (!url) {
          return;
        }
        window.open(url, '_blank', 'noopener');
        closeMenu();
      });
    });

    const mobileTargets = header.querySelectorAll('[data-mobile-nav-target]');
    mobileTargets.forEach((link) => {
      link.addEventListener('click', () => {
        closeMenu();
      });
    });
  }
</script>
