---
import BaseLayout from '~/layouts/BaseLayout.astro';
import IndexHeroSection from '~/components/IndexHeroSection';
import BookCard from '~/components/BookCard';
import { executeQuery } from '~/lib/datocms/executeQuery';
import { toPlainText } from '~/lib/text';
import { mapBooksToCards } from '~/lib/books';
import { withFallbackSeo } from '~/lib/seo';
import styles from './_style.module.css';
import { ARCHIVE_PAGE_QUERY, type ArchivePageQueryResult } from './_graphql';
import DraftModeQueryListener from '~/components/DraftModeQueryListener';
import { resolveDraftMode } from '~/lib/draftPreview';

const draftModeEnabled = resolveDraftMode(Astro);

const data = await executeQuery<ArchivePageQueryResult>(ARCHIVE_PAGE_QUERY, {
  includeDrafts: draftModeEnabled,
});

const archiveIndexContent = data.archiveIndexPage?.[0] ?? null;
const heroSection = {
  title: archiveIndexContent?.title?.trim() || 'Fuori catalogo',
  subtitleHtml: archiveIndexContent?.subtitle?.trim() || null,
};
const seo = withFallbackSeo(archiveIndexContent?._seoMetaTags, {
  title: heroSection.title,
  description: heroSection.subtitleHtml ? toPlainText(heroSection.subtitleHtml) : undefined,
});

const archiveBooks = mapBooksToCards(data.allBooks ?? []);
export const prerender = false;
---

<BaseLayout seo={seo}>
  <section class={styles.section}>
    <div class={styles.intro}>
      <IndexHeroSection
        title={heroSection.title}
        subtitleHtml={heroSection.subtitleHtml}
        align="center"
      />
    </div>

    {
      archiveBooks.length === 0 ? (
        <p class={styles.empty}>
          Stiamo completando la digitalizzazione dei titoli fuori catalogo.
        </p>
      ) : (
        <div class={styles.gridWrapper}>
          <div class={styles.booksGrid}>
            {archiveBooks.map((book) => (
              <BookCard
                title={book.title}
                slug={book.slug}
                subtitle={book.subtitle}
                summary={book.summary}
                coverImage={book.coverImage}
                authors={book.authors}
                license={book.license}
                format={book.format}
                price={book.price}
                isArchived={book.isArchived}
              />
            ))}
          </div>
        </div>
      )
    }
  </section>
  <DraftModeQueryListener query={ARCHIVE_PAGE_QUERY} />
</BaseLayout>
