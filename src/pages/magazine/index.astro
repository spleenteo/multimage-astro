---
import BaseLayout from '~/layouts/BaseLayout.astro';
import IndexHeroSection from '~/components/IndexHeroSection';
import MagazinePostCard from '~/components/MagazinePostCard';
import { executeQuery } from '~/lib/datocms/executeQuery';
import { withFallbackSeo } from '~/lib/seo';
import { toPlainText } from '~/lib/text';
import type { ResponsiveImage } from '~/lib/datocms/types';
import styles from './index/_style.module.css';
import { MAGAZINE_INDEX_QUERY, type MagazineIndexQueryResult } from './index/_graphql';
import DraftModeQueryListener from '~/components/DraftModeQueryListener';
import { resolveDraftMode } from '~/lib/draftPreview';

const draftModeEnabled = resolveDraftMode(Astro);

const data = await executeQuery<MagazineIndexQueryResult>(MAGAZINE_INDEX_QUERY, {
  includeDrafts: draftModeEnabled,
});

const magazineIndexContent = data.magazineIndexPage?.[0] ?? null;
const heroSection = {
  title: magazineIndexContent?.title?.trim() || 'Magazine',
  subtitleHtml: magazineIndexContent?.subtitle?.trim() || null,
};

const seo = withFallbackSeo(magazineIndexContent?._seoMetaTags, {
  title: `${heroSection.title} | Multimage`,
  description: heroSection.subtitleHtml ? toPlainText(heroSection.subtitleHtml) : undefined,
});

type PostCard = {
  id: string;
  slug: string;
  title: string;
  abstract?: string | null;
  sticky?: boolean | null;
  publishedAt?: string | null;
  category?: {
    name?: string | null;
    slug?: string | null;
  } | null;
  authorName?: string | null;
  image?: ResponsiveImage | null;
};

const posts: PostCard[] = (data.allBlogPosts ?? [])
  .filter((post) => Boolean(post?.slug) && Boolean(post?.title))
  .map((post) => ({
    id: post.id,
    slug: post.slug ?? '',
    title: post.title ?? 'Articolo',
    abstract: post.abstract,
    sticky: post.sticky,
    publishedAt: post.createdAt,
    category: post.category,
    authorName: post.author?.name ?? null,
    image: post.featuredImage?.responsiveImage ?? null,
  }))
  .sort((a, b) => Number(b.sticky === true) - Number(a.sticky === true));
export { prerender } from '~/lib/prerender';
---

<BaseLayout seo={seo}>
  <div class={styles.layout}>
    <section class={styles.heroSection}>
      <p class={styles.label}>Magazine</p>
      <IndexHeroSection
        title={heroSection.title}
        subtitleHtml={heroSection.subtitleHtml}
        align="center"
      />
    </section>

    {
      posts.length === 0 ? (
        <p class={styles.empty}>Gli articoli del magazine saranno disponibili a breve.</p>
      ) : (
        <section>
          <div class={styles.cardsGrid}>
            {posts.map((post) => (
              <MagazinePostCard
                title={post.title}
                slug={post.slug}
                abstract={post.abstract}
                publishedAt={post.publishedAt}
                category={post.category}
                authorName={post.authorName}
                image={post.image}
                sticky={post.sticky}
              />
            ))}
          </div>
        </section>
      )
    }
  </div>
  <DraftModeQueryListener query={MAGAZINE_INDEX_QUERY} />
</BaseLayout>
