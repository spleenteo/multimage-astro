---
import BaseLayout from '~/layouts/BaseLayout.astro';
import { Image } from '@datocms/astro/Image';
import { executeQuery } from '~/lib/datocms/executeQuery';
import { TAG_FRAGMENT, RESPONSIVE_IMAGE_FRAGMENT } from '~/lib/datocms/commonFragments';
import { withFallbackSeo } from '~/lib/seo';
import { toPlainText, toRichTextHtml } from '~/lib/text';
import { toBookCard, formatBookPrice } from '~/lib/books';
import type { BookRecordForCard } from '~/lib/books';
import type { HomeRecord, SeoMetaTag } from '~/lib/datocms/types';

export const prerender = true;

const FEATURE_LINKS = [
  {
    href: '/libri',
    title: 'Catalogo libri',
    icon: 'iconoir:book',
    description:
      'Sfoglia le pubblicazioni dedicate a diritti umani, nonviolenza e trasformazione sociale.',
  },
  {
    href: '/autori',
    title: 'Autori e autrici',
    icon: 'iconoir:community',
    description:
      'Approfondimenti biografici, interviste e opere dei protagonisti della collana Multimage.',
  },
  {
    href: '/collane',
    title: 'Collane editoriali',
    icon: 'iconoir:bookmark-book',
    description:
      'Percorsi tematici e serie storiche, presto disponibili con filtri e navigazione dinamica.',
  },
] as const;

const HOME_QUERY = /* GraphQL */ `
  ${TAG_FRAGMENT}
  ${RESPONSIVE_IMAGE_FRAGMENT}
  query HomePage {
    home {
      title
      claim
      heroImage {
        alt
        title
        responsiveImage(
          imgixParams: { fit: crop, w: 1920, h: 1080, auto: format, crop: focalpoint }
        ) {
          ...ResponsiveImageFragment
        }
      }
      highlight {
        id
        title
        subtitle
        slug
        promo
        description
        coverImage {
          url
          alt
          colors {
            hex
          }
          responsiveImage(imgixParams: { fit: max, w: 520, auto: format }) {
            ...ResponsiveImageFragment
          }
        }
        authors {
          id
          fullName
        }
        license {
          name
          code
        }
        format
        price
        printYear
        archive
        collection {
          id
          name
          slug
        }
      }
      _seoMetaTags {
        ...TagFragment
      }
    }
  }
`;

type HighlightBookRecord = BookRecordForCard & {
  collection?: {
    id: string;
    name: string | null;
    slug: string | null;
  } | null;
};

type HomeQueryResult = {
  home:
    | (HomeRecord & {
        _seoMetaTags: SeoMetaTag[] | null;
        highlight: HighlightBookRecord | null;
      })
    | null;
};

const { home } = await executeQuery<HomeQueryResult>(HOME_QUERY);
const defaultTitle = 'La casa editrice dei diritti umani';
const defaultClaimHtml = `<p>Multimage promuove libri, autori e iniziative che raccontano i diritti umani, la nonviolenza e le storie spesso dimenticate. Questa nuova applicazione Astro riprende colori e tipografia dell'esperienza originale per offrire una base moderna e accessibile.</p>`;

const heroTitle = home?.title?.trim() || defaultTitle;
const heroClaimHtml = toRichTextHtml(home?.claim) ?? defaultClaimHtml;
const heroClaimText = toPlainText(heroClaimHtml);

const heroResponsiveImage = home?.heroImage?.responsiveImage ?? null;
const heroImageAlt = home?.heroImage?.alt?.trim() ?? `${heroTitle} | Multimage`;
const heroImageTitle = home?.heroImage?.title?.trim() ?? heroTitle;

const heroImageData = heroResponsiveImage
  ? { ...heroResponsiveImage, alt: heroResponsiveImage.alt ?? heroImageAlt, title: heroImageTitle }
  : null;

const highlightRaw = home?.highlight ?? null;
const highlightBook = highlightRaw ? toBookCard(highlightRaw) : null;
const highlightCollection = highlightRaw?.collection ?? null;
const highlightCollectionName = highlightCollection?.name?.trim() ?? null;
const highlightCollectionSlug = highlightCollection?.slug?.trim() ?? null;
const highlightCollectionHref = highlightCollectionSlug
  ? `/collane/${highlightCollectionSlug}`
  : null;
const highlightCollectionLabel = highlightCollectionName
  ? `Collana ${highlightCollectionName}`
  : null;
const highlightAuthors = highlightBook?.authors ?? [];
const highlightAuthorsLabel =
  highlightAuthors.length > 0
    ? highlightAuthors
        .map((author) => author.fullName?.trim())
        .filter((name): name is string => Boolean(name))
        .join(', ')
    : 'Autore in aggiornamento';
const highlightSummary = highlightBook?.summary ?? null;
const highlightPriceLabel = formatBookPrice(highlightBook?.price ?? null);
const highlightFormat = highlightBook?.format?.trim() ?? null;
const highlightPrintYear = highlightBook?.printYear ?? null;
const highlightIsArchived = highlightBook?.isArchived === true;
const highlightResponsiveImage = highlightBook?.coverImage?.responsiveImage ?? null;
const highlightCoverAlt = highlightBook?.coverImage?.alt ?? highlightBook?.title ?? 'Copertina';
const highlightImageData = highlightResponsiveImage
  ? { ...highlightResponsiveImage, alt: highlightResponsiveImage.alt ?? highlightCoverAlt }
  : null;
const highlightLink = highlightBook ? `/libri/${highlightBook.slug}` : null;

const seo = withFallbackSeo(home?._seoMetaTags, {
  title: heroTitle.includes('Multimage') ? heroTitle : `${heroTitle} | Multimage`,
  description: heroClaimText,
});
---

<BaseLayout seo={seo}>
  <div class="space-y-12">
    <section
      class="relative left-1/2 w-screen max-w-none -translate-x-1/2 overflow-hidden bg-brand-charcoal text-white shadow-soft min-h-[45vh] mt-[-3rem] md:mt-[-4rem]"
    >
      {
        heroImageData ? (
          <Image
            data={heroImageData}
            sizes="(min-width: 1280px) 1200px, 100vw"
            pictureClass="absolute inset-0 block h-full w-full"
            imgClass="h-full w-full object-cover"
            imgStyle={{ objectFit: 'cover', width: '100%', height: '100%', maxWidth: 'none' }}
            priority
          />
        ) : (
          <div class="absolute inset-0 bg-brand-navy" aria-hidden="true" />
        )
      }
      <div class="absolute inset-0 bg-black/45" aria-hidden="true"></div>
      <div
        class="relative z-10 mx-auto flex min-h-[360px] w-full max-w-5xl flex-col items-center justify-center gap-6 px-6 py-24 text-center md:min-h-[45vh] md:px-12"
      >
        <h1 class="text-4xl font-serif tracking-tight text-white md:text-5xl lg:text-6xl">
          {heroTitle}
        </h1>
        <div class="h-px w-20 bg-white/70"></div>
        {
          heroClaimHtml ? (
            <div
              class="max-w-3xl text-lg leading-relaxed text-white/90 md:text-xl [&_a]:text-white [&_a:hover]:text-white/80 [&_p:not(:last-child)]:mb-4"
              set:html={heroClaimHtml}
            />
          ) : null
        }
      </div>
    </section>

    {
      highlightBook ? (
        <section class="rounded-3xl border border-white/70 bg-white/95 shadow-soft">
          <div class="flex flex-col overflow-hidden md:flex-row">
            <div class="bg-brand-mist/60 md:w-[38%] md:max-w-md">
              {highlightImageData ? (
                <Image
                  data={highlightImageData}
                  sizes="(min-width: 1024px) 360px, 80vw"
                  pictureClass="block h-full w-full"
                  imgClass="h-full w-full object-contain"
                  imgStyle={{ objectFit: 'cover', width: '100%', height: '100%', maxWidth: 'none' }}
                />
              ) : (
                <div class="flex min-h-[280px] items-center justify-center px-6 text-center text-sm font-semibold uppercase tracking-[0.2em] text-brand-slate">
                  Copertina in arrivo
                </div>
              )}
            </div>
            <div class="flex flex-1 flex-col gap-6 px-6 py-8 md:px-10 md:py-12">
              <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                <div class="flex flex-wrap items-center gap-3 text-xs font-semibold uppercase tracking-wider text-brand-slate">
                  <span>In evidenza</span>
                  {highlightCollectionHref ? (
                    <a
                      href={highlightCollectionHref}
                      class="inline-flex items-center gap-2 text-brand-navy transition hover:text-brand-sky"
                    >
                      <iconify-icon
                        icon="iconoir:bookmark-book"
                        width="16"
                        height="16"
                        aria-hidden="true"
                      />
                      <span>{highlightCollectionLabel}</span>
                    </a>
                  ) : highlightCollectionLabel ? (
                    <span class="text-brand-charcoal">{highlightCollectionLabel}</span>
                  ) : null}
                </div>
                {highlightIsArchived ? (
                  <span class="inline-flex items-center bg-brand-slate px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.2em] text-white">
                    Fuori catalogo
                  </span>
                ) : null}
              </div>

              <div class="space-y-2 text-left">
                <h2 class="text-3xl font-serif text-brand-navy md:text-4xl">
                  {highlightBook.title}
                </h2>
                {highlightBook.subtitle ? (
                  <p class="text-lg font-medium text-brand-charcoal/80">{highlightBook.subtitle}</p>
                ) : null}
                <p class="text-sm font-semibold uppercase tracking-wide text-brand-charcoal/80">
                  {highlightAuthorsLabel}
                </p>
              </div>

              {highlightSummary ? (
                <p class="text-base leading-relaxed text-brand-charcoal/80">{highlightSummary}</p>
              ) : null}

              <div class="flex flex-wrap items-center gap-4 text-sm font-semibold uppercase tracking-wide text-brand-charcoal/70">
                {highlightPriceLabel ? <span>Prezzo {highlightPriceLabel}</span> : null}
                {highlightFormat ? <span>Formato {highlightFormat}</span> : null}
                {highlightPrintYear ? <span>Anno {highlightPrintYear}</span> : null}
              </div>

              <div class="flex flex-wrap items-center gap-3 pt-2">
                {highlightLink ? (
                  <a href={highlightLink} class="btn-primary">
                    Scopri il libro
                  </a>
                ) : null}
                {highlightCollectionHref ? (
                  <a
                    href={highlightCollectionHref}
                    class="inline-flex items-center gap-2 border border-brand-navy px-5 py-2 text-xs font-semibold uppercase tracking-widest text-brand-navy transition hover:bg-brand-navy hover:text-white"
                  >
                    <span>Vai alla collana</span>
                    <iconify-icon
                      icon="iconoir:nav-arrow-right"
                      width="16"
                      height="16"
                      aria-hidden="true"
                    />
                  </a>
                ) : null}
              </div>
            </div>
          </div>
        </section>
      ) : null
    }

    <section class="space-y-6">
      <h2>Prossime integrazioni</h2>
      <p>
        Stiamo portando nel progetto tutte le sezioni presenti nella copia statica: catalogo libri,
        schede autore, collane editoriali e pagine informative. Le schede sottostanti anticipano la
        struttura che verrà popolata con contenuti reali.
      </p>
      <div class="grid gap-6 md:grid-cols-3">
        {
          FEATURE_LINKS.map(({ href, title, description, icon }) => (
            <a
              href={href}
              class="group flex h-full flex-col justify-between bg-brand-mist p-6 text-brand-charcoal transition hover:-translate-y-1 hover:bg-white"
            >
              <div class="space-y-3">
                <span class="inline-flex h-12 w-12 items-center justify-center bg-white text-brand-navy shadow-soft">
                  <iconify-icon icon={icon} width="24" height="24" aria-hidden="true" />
                </span>
                <h3 class="text-xl font-serif text-brand-navy group-hover:text-brand-sky">
                  {title}
                </h3>
                <p>{description}</p>
              </div>
              <span class="mt-6 inline-flex items-center gap-2 text-sm font-semibold uppercase tracking-wider text-brand-sky group-hover:text-brand-navy">
                <span>Apri sezione</span>
                <iconify-icon
                  icon="iconoir:nav-arrow-right"
                  width="16"
                  height="16"
                  aria-hidden="true"
                />
              </span>
            </a>
          ))
        }
      </div>
    </section>
  </div>
</BaseLayout>
