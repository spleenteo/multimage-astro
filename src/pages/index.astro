---
import BaseLayout from '~/layouts/BaseLayout.astro';
import FeaturedBookHighlight from '~/components/FeaturedBookHighlight.astro';
import BannerSection from '~/components/bannerSection.astro';
import { Image } from '@datocms/astro/Image';
import { executeQuery } from '~/lib/datocms/executeQuery';
import { TAG_FRAGMENT, RESPONSIVE_IMAGE_FRAGMENT } from '~/lib/datocms/commonFragments';
import { withFallbackSeo } from '~/lib/seo';
import { toPlainText, toRichTextHtml } from '~/lib/text';
import { toBookCard, formatBookPrice } from '~/lib/books';
import { formatAuthorNames, getAuthorDisplayName } from '~/lib/authors';
import type { BookRecordForCard } from '~/lib/books';
import type { AssetColor, HomeRecord, ResponsiveImage, SeoMetaTag } from '~/lib/datocms/types';

export const prerender = true;

const FEATURE_LINKS = [
  {
    href: '/libri',
    title: 'Catalogo libri',
    icon: 'iconoir:book',
    description:
      'Sfoglia le pubblicazioni dedicate a diritti umani, nonviolenza e trasformazione sociale.',
  },
  {
    href: '/autori',
    title: 'Autrici e autori',
    icon: 'iconoir:community',
    description:
      'Approfondimenti biografici, interviste e opere dei protagonisti del catalogo Multimage.',
  },
  {
    href: '/collane',
    title: 'Collane editoriali',
    icon: 'iconoir:bookmark-book',
    description: 'Percorsi tematici. serie storiche, raccolte e.',
  },
] as const;

const HOME_QUERY = /* GraphQL */ `
  ${TAG_FRAGMENT}
  ${RESPONSIVE_IMAGE_FRAGMENT}
  query HomePage {
    home {
      title
      claim
      heroImage {
        alt
        title
        responsiveImage(
          imgixParams: { fit: crop, w: 1920, h: 1080, auto: format, crop: focalpoint }
        ) {
          ...ResponsiveImageFragment
        }
      }
      highlight {
        id
        title
        subtitle
        slug
        promo
        description
        coverImage {
          url
          alt
          colors {
            hex
          }
          responsiveImage(imgixParams: { fit: max, w: 520, auto: format }) {
            ...ResponsiveImageFragment
          }
        }
        authors {
          id
          fullName
          alias
          slug
        }
        license {
          name
          code
        }
        format
        price
        printYear
        archive
        collection {
          id
          name
          slug
        }
      }
      _seoMetaTags {
        ...TagFragment
      }
      banners {
        __typename
        ... on BannerRecord {
          id
          title
          content
          link
          imagePosition
          featuredImage {
            alt
            title
            colors {
              hex
            }
            responsiveImage(imgixParams: { fit: max, w: 600, auto: format }) {
              ...ResponsiveImageFragment
            }
          }
        }
      }
    }
  }
`;

const HIGHLIGHT_AUTHOR_QUERY = /* GraphQL */ `
  ${RESPONSIVE_IMAGE_FRAGMENT}
  query HighlightAuthorDetails($authorId: ItemId) {
    author(filter: { id: { eq: $authorId } }) {
      id
      fullName
      alias
      slug
      picture {
        alt
        responsiveImage(imgixParams: { fit: crop, w: 220, h: 220, auto: format, crop: faces }) {
          ...ResponsiveImageFragment
        }
      }
    }
    booksCount: _allBooksMeta(filter: { authors: { anyIn: [$authorId] } }) {
      count
    }
  }
`;

type HighlightBookRecord = BookRecordForCard & {
  collection?: {
    id: string;
    name: string | null;
    slug: string | null;
  } | null;
};

type HomeBannerBlockRecord = {
  __typename: 'BannerRecord';
  id: string;
  title: string | null;
  content: string | null;
  link: string | null;
  imagePosition: 'left' | 'right' | null;
  featuredImage: {
    alt: string | null;
    title: string | null;
    colors: AssetColor[] | null;
    responsiveImage: ResponsiveImage | null;
  } | null;
};

type HomeBannerSectionData = {
  id: string;
  title: string | null;
  contentHtml: string | null;
  link: string | null;
  imagePosition: 'left' | 'right';
  image: (ResponsiveImage & { title?: string | null }) | null;
  colors: AssetColor[] | null;
};

type HomeQueryResult = {
  home:
    | (HomeRecord & {
        _seoMetaTags: SeoMetaTag[] | null;
        highlight: HighlightBookRecord | null;
        banners: HomeBannerBlockRecord[] | null;
      })
    | null;
};

type HighlightAuthorQueryResult = {
  author: {
    id: string;
    fullName: string | null;
    alias: string | null;
    slug: string | null;
    picture: {
      alt: string | null;
      responsiveImage: ResponsiveImage | null;
    } | null;
  } | null;
  booksCount: {
    count: number;
  } | null;
};

const { home } = await executeQuery<HomeQueryResult>(HOME_QUERY);
const defaultTitle = 'La casa editrice dei diritti umani';
const defaultClaimHtml = `<p>Multimage promuove libri, autori e iniziative che raccontano i diritti umani, la nonviolenza e le storie spesso dimenticate. Questa nuova applicazione Astro riprende colori e tipografia dell'esperienza originale per offrire una base moderna e accessibile.</p>`;

const heroTitle = home?.title?.trim() || defaultTitle;
const heroClaimHtml = toRichTextHtml(home?.claim) ?? defaultClaimHtml;
const heroClaimText = toPlainText(heroClaimHtml);

const heroResponsiveImage = home?.heroImage?.responsiveImage ?? null;
const heroImageAlt = home?.heroImage?.alt?.trim() ?? `${heroTitle} | Multimage`;

const heroImageData = heroResponsiveImage
  ? {
      ...heroResponsiveImage,
      alt: heroResponsiveImage.alt ?? heroImageAlt,
      title: heroResponsiveImage.title ?? heroTitle,
    }
  : null;

const highlightRaw = home?.highlight ?? null;
const highlightPrimaryAuthorRaw = highlightRaw?.authors?.[0] ?? null;

let highlightAuthorData: HighlightAuthorQueryResult | null = null;
if (highlightPrimaryAuthorRaw?.id) {
  highlightAuthorData = await executeQuery<HighlightAuthorQueryResult>(HIGHLIGHT_AUTHOR_QUERY, {
    variables: { authorId: highlightPrimaryAuthorRaw.id },
  });
}

const highlightAuthorDetails = highlightAuthorData?.author ?? null;
const highlightAuthorBooksCount = highlightAuthorData?.booksCount?.count ?? null;

const highlightBook = highlightRaw ? toBookCard(highlightRaw) : null;
const highlightCollection = highlightRaw?.collection ?? null;
const highlightCollectionName = highlightCollection?.name?.trim() ?? null;
const highlightCollectionSlug = highlightCollection?.slug?.trim() ?? null;
const highlightCollectionHref = highlightCollectionSlug
  ? `/collane/${highlightCollectionSlug}`
  : null;
const highlightCollectionLabel = highlightCollectionName
  ? `Collana ${highlightCollectionName}`
  : null;
const highlightAuthors = highlightBook?.authors ?? [];
const highlightAuthorsLabel = formatAuthorNames(highlightAuthors);
const highlightSummary = highlightBook?.summary ?? null;
const highlightPriceLabel = formatBookPrice(highlightBook?.price ?? null);
const highlightFormat = highlightBook?.format?.trim() ?? null;
const highlightPrintYear = highlightBook?.printYear ?? null;
const highlightIsArchived = highlightBook?.isArchived === true;
const highlightResponsiveImage = highlightBook?.coverImage?.responsiveImage ?? null;
const highlightCoverAlt = highlightBook?.coverImage?.alt ?? highlightBook?.title ?? 'Copertina';
const highlightImageData = highlightResponsiveImage
  ? { ...highlightResponsiveImage, alt: highlightResponsiveImage.alt ?? highlightCoverAlt }
  : null;
const highlightLink = highlightBook ? `/libri/${highlightBook.slug}` : null;
const highlightAuthorName = highlightAuthorDetails
  ? getAuthorDisplayName(highlightAuthorDetails)
  : highlightPrimaryAuthorRaw
    ? getAuthorDisplayName(highlightPrimaryAuthorRaw)
    : null;
const highlightAuthorSlug = highlightAuthorDetails?.slug ?? highlightPrimaryAuthorRaw?.slug ?? null;
const highlightAuthorPicture = highlightAuthorDetails?.picture?.responsiveImage ?? null;
const highlightAuthorPictureAlt =
  highlightAuthorDetails?.picture?.alt ??
  highlightAuthorDetails?.fullName ??
  highlightAuthorName ??
  'Ritratto autore';
const highlightAuthorLink = highlightAuthorSlug ? `/autori/${highlightAuthorSlug}` : null;
const highlightAuthorProfile = highlightAuthorName
  ? {
      name: highlightAuthorName,
      slug: highlightAuthorSlug,
      link: highlightAuthorLink,
      booksCount: highlightAuthorBooksCount,
      picture: highlightAuthorPicture,
      pictureAlt: highlightAuthorPictureAlt,
    }
  : null;
const highlightCoverColors = highlightBook?.coverImage?.colors ?? null;

const bannerBlocks = home?.banners ?? [];
const homeBannerSections: HomeBannerSectionData[] = bannerBlocks
  .filter((block): block is HomeBannerBlockRecord => block?.__typename === 'BannerRecord')
  .map((block) => {
    const trimmedTitle = block.title?.trim() ?? null;
    const contentHtml = toRichTextHtml(block.content) ?? null;
    const link = block.link?.trim() ?? null;
    const position = block.imagePosition === 'left' ? 'left' : 'right';
    const featuredImage = block.featuredImage ?? null;
    const responsiveImage = featuredImage?.responsiveImage ?? null;
    const fallbackAlt = featuredImage?.alt?.trim() ?? trimmedTitle ?? 'Illustrazione';
    const fallbackTitle = featuredImage?.title?.trim() ?? trimmedTitle ?? fallbackAlt;
    const image = responsiveImage
      ? {
          ...responsiveImage,
          alt: responsiveImage.alt ?? fallbackAlt,
          title: responsiveImage.title ?? fallbackTitle,
        }
      : null;

    return {
      id: block.id,
      title: trimmedTitle,
      contentHtml,
      link,
      imagePosition: position,
      image,
      colors: featuredImage?.colors ?? null,
    };
  });

const seo = withFallbackSeo(home?._seoMetaTags, {
  title: heroTitle.includes('Multimage') ? heroTitle : `${heroTitle} | Multimage`,
  description: heroClaimText,
});
---

<BaseLayout seo={seo}>
  <div class="space-y-12">
    <section
      class="relative left-1/2 w-screen max-w-none -translate-x-1/2 overflow-hidden bg-brand-charcoal text-white shadow-soft min-h-[45vh] mt-[-3rem] md:mt-[-4rem]"
    >
      {
        heroImageData ? (
          <Image
            data={heroImageData}
            sizes="(min-width: 1280px) 1200px, 100vw"
            pictureClass="absolute inset-0 block h-full w-full"
            imgClass="h-full w-full object-cover"
            imgStyle={{ objectFit: 'cover', width: '100%', height: '100%', maxWidth: 'none' }}
            priority
          />
        ) : (
          <div class="absolute inset-0 bg-brand-navy" aria-hidden="true" />
        )
      }
      <div class="absolute inset-0 bg-black/45" aria-hidden="true"></div>
      <div
        class="relative z-10 mx-auto flex min-h-[360px] w-full max-w-5xl flex-col items-center justify-center gap-6 px-6 py-24 text-center md:min-h-[45vh] md:px-12"
      >
        <h1 class="text-4xl font-serif tracking-tight text-white md:text-5xl lg:text-6xl">
          {heroTitle}
        </h1>
        <div class="h-px w-20 bg-white/70"></div>
        {
          heroClaimHtml ? (
            <div
              class="max-w-3xl text-lg leading-relaxed text-white/90 md:text-xl [&_a]:text-white [&_a:hover]:text-white/80 [&_p:not(:last-child)]:mb-4"
              set:html={heroClaimHtml}
            />
          ) : null
        }
      </div>
    </section>

    {
      highlightBook ? (
        <FeaturedBookHighlight
          book={{
            title: highlightBook.title,
            subtitle: highlightBook.subtitle ?? null,
            summary: highlightSummary ?? undefined,
            priceLabel: highlightPriceLabel ?? undefined,
            format: highlightFormat ?? undefined,
            printYear: highlightPrintYear ?? undefined,
            isArchived: highlightIsArchived,
            link: highlightLink ?? undefined,
            authorsLabel: highlightAuthorsLabel,
          }}
          coverImage={highlightImageData}
          collectionLabel={highlightCollectionLabel}
          collectionHref={highlightCollectionHref}
          author={
            highlightAuthorProfile
              ? {
                  name: highlightAuthorProfile.name,
                  link: highlightAuthorProfile.link,
                  slug: highlightAuthorProfile.slug ?? null,
                  booksCount: highlightAuthorProfile.booksCount ?? null,
                  picture: highlightAuthorProfile.picture ?? null,
                  pictureAlt: highlightAuthorProfile.pictureAlt,
                }
              : null
          }
          coverColors={highlightCoverColors}
        />
      ) : null
    }

    {
      homeBannerSections.length > 0 ? (
        <div class="space-y-10">
          {homeBannerSections.map((banner) => (
            <BannerSection {...banner} />
          ))}
        </div>
      ) : null
    }

    <section class="space-y-6">
      <h2>Cosa cerchi?</h2>
      <p>
        Le sezioni principali di una casa di edtrice sono senza dubbio i Libri, le autrici/autori e
        le collane editoriali che componono il nostro catalogo.
      </p>
      <div class="grid gap-6 md:grid-cols-3">
        {
          FEATURE_LINKS.map(({ href, title, description, icon }) => (
            <a
              href={href}
              class="group flex h-full flex-col justify-between bg-brand-mist p-6 text-brand-charcoal transition hover:-translate-y-1 hover:bg-white"
            >
              <div class="space-y-3">
                <span class="inline-flex h-12 w-12 items-center justify-center bg-white text-brand-navy shadow-soft">
                  <iconify-icon icon={icon} width="24" height="24" aria-hidden="true" />
                </span>
                <h3 class="text-xl font-serif text-brand-navy group-hover:text-brand-sky">
                  {title}
                </h3>
                <p>{description}</p>
              </div>
              <span class="mt-6 inline-flex items-center gap-2 text-sm font-semibold uppercase tracking-wider text-brand-sky group-hover:text-brand-navy">
                <span>Scopri sezione</span>
                <iconify-icon
                  icon="iconoir:nav-arrow-right"
                  width="16"
                  height="16"
                  aria-hidden="true"
                />
              </span>
            </a>
          ))
        }
      </div>
    </section>
  </div>
</BaseLayout>
