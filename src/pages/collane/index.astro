---
import BaseLayout from '~/layouts/BaseLayout.astro';
import IndexHeroSection from '~/components/IndexHeroSection';
import CollectionCard from '~/components/CollectionCard';
import { executeQuery } from '~/lib/datocms/executeQuery';
import { toPlainText, truncateToLength } from '~/lib/text';
import { withFallbackSeo } from '~/lib/seo';
import type { CollectionSummaryRecord } from '~/lib/datocms/types';
import styles from './index/_style.module.css';
import { COLLECTIONS_PAGE_QUERY, type CollectionsQueryResult } from './index/_graphql';
import DraftModeQueryListener from '~/components/DraftModeQueryListener';
import { resolveDraftMode } from '~/lib/draftPreview';

const draftModeEnabled = resolveDraftMode(Astro);

const data = await executeQuery<CollectionsQueryResult>(COLLECTIONS_PAGE_QUERY, {
  includeDrafts: draftModeEnabled,
});

const collectionsIndexContent = data.collectionsIndexPage?.[0] ?? null;
const heroSection = {
  title: collectionsIndexContent?.title?.trim() || 'Collane',
  subtitleHtml: collectionsIndexContent?.subtitle?.trim() || null,
};
const seo = withFallbackSeo(collectionsIndexContent?._seoMetaTags, {
  title: heroSection.title,
  description: heroSection.subtitleHtml ? toPlainText(heroSection.subtitleHtml) : undefined,
});

const bookCounts = new Map<string, number>();
for (const book of data.allBooks ?? []) {
  const collectionId = book.collection?.id;
  if (!collectionId) continue;
  bookCounts.set(collectionId, (bookCounts.get(collectionId) ?? 0) + 1);
}

const collections: Array<{
  name: string;
  slug: string;
  description: string | null;
  logo: CollectionSummaryRecord['logo'];
  booksCount: number;
}> = [];

for (const collection of data.allCollections ?? []) {
  const name = collection.name ?? 'Collana senza titolo';
  const slug = collection.slug ?? '';
  if (!slug) {
    continue;
  }

  collections.push({
    name,
    slug,
    description: truncateToLength(toPlainText(collection.description ?? ''), 160) || null,
    logo: collection.logo,
    booksCount: bookCounts.get(collection.id) ?? 0,
  });
}
export { prerender } from '~/lib/prerender';
---

<BaseLayout seo={seo}>
  <section class={styles.section}>
    <div class={styles.intro}>
      <IndexHeroSection title={heroSection.title} subtitleHtml={heroSection.subtitleHtml} />
    </div>

    {
      collections.length === 0 ? (
        <p class={styles.empty}>Nessuna collana pubblicata trovata.</p>
      ) : (
        <div class={styles.collectionsGrid}>
          {collections.map((collection) => (
            <CollectionCard {...collection} />
          ))}
        </div>
      )
    }
  </section>
  <DraftModeQueryListener query={COLLECTIONS_PAGE_QUERY} />
</BaseLayout>
