---
import BaseLayout from '~/layouts/BaseLayout.astro';
import CollectionDetailHero from '~/components/CollectionDetailHero.astro';
import BookCard from '~/components/BookCard.astro';
import { executeQuery } from '~/lib/datocms/executeQuery';
import { graphql } from '~/lib/datocms/graphql';
import { toPlainText } from '~/lib/text';
import { mapBooksToCards } from '~/lib/books';
import { withFallbackSeo } from '~/lib/seo';

export const prerender = true;

const COLLECTION_DETAIL_QUERY = graphql(/* GraphQL */ `
  query CollectionDetailPage($slug: String) {
    collection(filter: { slug: { eq: $slug } }) {
      id
      name
      description
      slug
      logo {
        url
        alt
      }
      _seoMetaTags {
        tag
        attributes
        content
      }
    }
  }
`);

const COLLECTION_RELATED_BOOKS_QUERY = graphql(/* GraphQL */ `
  query CollectionRelatedBooks($collectionId: ItemId) {
    _allBooksMeta(filter: { collection: { eq: $collectionId } }) {
      count
    }
    allBooks(filter: { collection: { eq: $collectionId } }, orderBy: title_ASC, first: 60) {
      id
      title
      subtitle
      slug
      promo
      description
      coverImage {
        url
        alt
        colors {
          hex
        }
        width
        height
      }
      authors {
        id
        fullName
      }
      license {
        name
        code
      }
      format
      price
      archive
    }
  }
`);

type SeoMetaTag = {
  tag: string;
  attributes: Record<string, string> | null;
  content: string | null;
};

type CollectionDetailResult = {
  collection: {
    id: string;
    name: string;
    description: string | null;
    slug: string;
    logo: {
      url: string;
      alt: string | null;
    } | null;
    _seoMetaTags: SeoMetaTag[] | null;
  } | null;
};

type CollectionRelatedBooksResult = {
  _allBooksMeta: {
    count: number;
  } | null;
  allBooks: Array<{
    id: string;
    title: string;
    subtitle: string | null;
    slug: string;
    promo: string | null;
    description: string | null;
    coverImage: {
      url: string;
      alt: string | null;
      colors?: Array<{ hex: string }>;
      width: number | null;
      height: number | null;
    } | null;
    authors: Array<{
      id: string;
      fullName: string | null;
    }>;
    license: {
      name: string | null;
      code: string | null;
    } | null;
    format: string | null;
    price: number | null;
    archive: boolean | null;
  }>;
};

type CollectionSlugsResult = {
  allCollections: Array<{
    slug: string | null;
  }>;
};

export async function getStaticPaths() {
  const slugsQuery = graphql(/* GraphQL */ `
    query CollectionSlugsForStaticPaths {
      allCollections(orderBy: name_ASC) {
        slug
      }
    }
  `);

  const data = (await executeQuery(slugsQuery)) as CollectionSlugsResult;

  return (data.allCollections ?? [])
    .map((collection) => collection.slug)
    .filter((slug): slug is string => Boolean(slug))
    .map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;

if (!slug) {
  throw new Error('Missing collection slug');
}

const detailData = (await executeQuery(COLLECTION_DETAIL_QUERY, {
  variables: { slug },
})) as CollectionDetailResult;

const collection = detailData.collection;

if (!collection) {
  throw new Error(`Collection not found for slug: ${slug}`);
}

const relatedData = (await executeQuery(COLLECTION_RELATED_BOOKS_QUERY, {
  variables: { collectionId: collection.id },
})) as CollectionRelatedBooksResult;

const descriptionPlain = toPlainText(collection.description ?? null);
const collectionDescription = descriptionPlain.length > 0 ? descriptionPlain : null;
const booksCount = relatedData._allBooksMeta?.count ?? 0;
const relatedBooks = mapBooksToCards(relatedData.allBooks);
const seo = withFallbackSeo(collection._seoMetaTags, {
  title: `${collection.name} | Multimage`,
  description: collectionDescription ?? undefined,
});
---

<BaseLayout seo={seo}>
  <article class="space-y-12">
    <CollectionDetailHero
      name={collection.name}
      booksCount={booksCount}
      description={collectionDescription}
      logo={collection.logo}
    />

    {
      relatedBooks.length === 0 ? (
        <p class="text-brand-slate">Nessun libro presente in questa collana.</p>
      ) : (
        <div class="grid gap-8 sm:grid-cols-2 xl:grid-cols-3">
          {relatedBooks.map((book) => (
            <BookCard
              title={book.title}
              slug={book.slug}
              subtitle={book.subtitle}
              summary={book.summary}
              coverImage={book.coverImage}
              authors={book.authors}
              license={book.license}
              format={book.format}
              price={book.price}
              isArchived={book.isArchived}
            />
          ))}
        </div>
      )
    }
  </article>
</BaseLayout>
