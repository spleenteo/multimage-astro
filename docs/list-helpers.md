---
agent_edit: true
scope: A list to describe all helpers, scripts, middlewares used in the project
---

- **`executeQuery`** (`src/lib/datocms/executeQuery.ts`)
  - Purpose: wraps `@datocms/cda-client`, automatically swapping the CDA token and `includeDrafts` flag when Draft Mode is enabled.
  - Used in: every GraphQL request (`BaseLayout`, pages, APIs).
  - Notes: throws descriptive errors if the required token is missing to avoid silent preview failures.
- **`draftMode` helpers** (`src/lib/draftMode.ts`)
  - Purpose: exposes `enableDraftMode`, `disableDraftMode`, `isDraftModeEnabled`, and `draftModeHeaders` so API routes and pages share the same logic.
  - Used in: `/api/preview`, `/api/draft-mode/*`, `BaseLayout`, and every page that needs to check whether previews are active.
  - Notes: relies on `SIGNED_COOKIE_JWT_SECRET` and the cookie name exported by `astro:env/client`. Page-level callers guard the helper with `import.meta.env.DEV` so prerendered builds never attempt to read cookies.
- **`draftPreview` utilities** (`src/lib/draftPreview.ts`)
  - Purpose: centralises Draft Mode resolution and exposes `resolveDraftMode(Astro)` for components/pages.
  - Used in: every CMS-driven page, BaseLayout, DraftModeQueryListener.
  - Notes: tutte le pagine CMS esportano `prerender = false`, quindi il helper legge i cookie sia in dev (`npm run dev`/`vercel dev`) sia sui deploy preview/prod di Vercel.
- **`commonFragments`** (`src/lib/datocms/commonFragments.ts`)
  - Purpose: exports shared `TagFragment` and `ResponsiveImageFragment`.
  - Used in: most `_graphql.ts` files to keep fragments DRY.
  - Notes: Book/Collection components rely on width/height—update carefully.
- **`recordInfo` helpers** (`src/lib/datocms/recordInfo.ts`)
  - Purpose: `recordToWebsiteRoute` and `recordToSlug` translate Dato records into site URLs/slugs.
  - Used in: `/api/preview-links`, `/api/seo-analysis`, and any future automations that need to resolve routes.
  - Notes: extend the switch statements whenever you add a routable model so preview links stay accurate.
- **`structuredText` helpers** (`src/lib/datocms/structuredText.ts`)
  - Purpose: converts Structured Text to plain text, checks emptiness.
  - Used in: SEO fallbacks, author summaries, info pages.
  - Notes: safe alternative to `toRichTextHtml` when sanitization is required.
- **`structuredTextComponents`** (`src/lib/datocms/structuredTextComponents.ts`)
  - Purpose: maps Structured Text blocks/inline/link nodes to Astro components (VideoBlock, LinkToRecord, etc.).
  - Notes: update this registry whenever components change (keep docs/list-components.md aligned).
- **`text` utilities** (`src/lib/text.ts`)
  - Purpose: `toPlainText`, `truncateToLength`, entity decoding, `toRichTextHtml`.
  - Used in: book hero copy, supplier bios, staff notices.
  - Notes: `toRichTextHtml` trusts HTML; see Security task **S2**.
- **`books` helper** (`src/lib/books.ts`)
  - Purpose: builds book view models, formats price/edition/licence/year.
  - Used in: listings, carousels, detail pages, staff exports.
  - Notes: `mapBooksToCards` is the canonical adapter for `BookCard` props.
- **`authors` helper** (`src/lib/authors.ts`)
  - Purpose: formats author names, chips, sort letters, and related metadata.
  - Used in: `/autori`, book detail sidebars, Structured Text.
  - Notes: exposes `AUTHOR_NAME_FALLBACK`, `buildAuthorSegments`, etc.
- **`suppliers` helper** (`src/lib/suppliers.ts`)
  - Purpose: converts Dato supplier records into card view models and region groups.
  - Used in: `/distributori`.
  - Notes: generates Google Maps URLs and rich-text HTML strings that must be sanitized (Security task **S2**).
- **`colors` helper** (`src/lib/colors.ts`)
  - Purpose: derives palette colors from Imgix metadata and blends shades.
  - Used in: `BookCard`, `FeaturedBookHighlight`, color-aware UI.
- **`currency` helper** (`src/lib/currency.ts`)
  - Purpose: formats `EUR` values (`it-IT`).
  - Used in: `PriceTag`, `BookCard`, staff exports.
- **`seo` helper** (`src/lib/seo.ts`)
  - Purpose: attaches fallback `<title>`/`<meta name="description">` tags when `_seoMetaTags` omit them.
  - Used in: every page via `withFallbackSeo`.
- **Dato type exports** (`src/lib/datocms/types.ts`)
  - Purpose: centralizes reusable TypeScript aliases for Dato records.
  - Notes: regenerate via `npx datocms schema:generate`; never edit manually.
- **Search client** (`src/pages/cerca/search-page.client.ts`)
  - Purpose: browser-only module powering `/cerca` (debounce, filters, URL sync, rendering).
  - Notes: bundled by `scripts/build-search-client.mjs`; tests tracked under docs/TODO.md task **TC2**.
- **Staff CSV exporter** (inline inside `src/pages/staff/archivio-catalogo/index.astro`)
  - Purpose: turns the prerendered `<table>` into a downloadable CSV with BOM.
  - Notes: slated for extraction + testing (Code Health task **CH1**).
- **Search/Swiper bundler** (`scripts/build-search-client.mjs`)
  - Purpose: builds `public/generated/search-page.client.js` and `swiper-element.js` via esbuild.
  - Notes: deletes stale artefacts and honors `NODE_ENV` for sourcemaps.
- **Dato sync script** (`scripts/sync-datocms.mjs`)
  - Purpose: loads `.env`, regenerates `schema.ts`, and refreshes `docs/DATOCMS.md` from the official dump.
  - Notes: requires `DATOCMS_API_TOKEN` or `DATOCMS_CMA_TOKEN` to run schema generation.
- **LLM export handler** (`src/pages/llms-full.txt.ts` + `_graphql.ts`)
  - Purpose: streams every book/author/page summary for AI tooling.
  - Notes: currently public with no auth—see Security task **S4**.
- **API response helpers** (`src/pages/api/utils.ts`)
  - Purpose: shared `withCORS`, `json`, `invalidRequestResponse`, `successfulResponse`, and `isRelativeUrl` utilities for every API route.
  - Used in: `/api/preview`, `/api/preview-links`, `/api/seo-analysis`, `/api/post-deploy`, etc.
  - Notes: keep `withCORS` in sync with Dato plugin requirements and reuse `isRelativeUrl` for any new redirect-bearing endpoints.
