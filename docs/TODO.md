- [ ] [Area: security] [Impact: P1] [Effort: M] Sanitize CMS-rich text before using set:html — toRichTextHtml returns raw markup and multiple components inject it directly, enabling XSS if editors paste HTML; render via StructuredText or sanitize output (src/lib/text.ts:65, src/pages/index.astro:351, src/components/SupplierCard/index.astro:78, src/pages/autori/[slug]/index.astro:156).
- [ ] [Area: security] [Impact: P1] [Effort: L] Lock down staff tools and CSV export — Staff pages are prerendered static routes exposing catalog/stock data without auth, relying only on robots.txt; move them behind authenticated API or remove from static build (src/pages/staff/index.astro:8, src/pages/staff/archivio-catalogo/index.astro:1, public/robots.txt:1).
- [ ] [Area: dato] [Impact: P2] [Effort: M] Restore draft/preview query pipeline — executeQuery hardcodes includeDrafts false and ignores draft tokens, preventing editorial previews; pick tokens based on draft mode and surface includeDrafts (src/lib/datocms/executeQuery.ts:13-26).
- [ ] [Area: dato] [Impact: P2] [Effort: M] Wire up DraftModeQueryListener & preview endpoints — AGENTS.md mandates live preview tooling but the project lacks listener/toggler components and an /api/preview handler; add them and guard with SECRET_API_TOKEN (AGENTS.md:73-89).
- [ ] [Area: performance] [Impact: P2] [Effort: M] Re-evaluate full-site ClientRouter transitions — BaseLayout mounts astro:transitions ClientRouter globally, forcing SPA-style hydration and extra JS on every route; scope or disable transitions to reduce client bundle (src/layouts/BaseLayout.astro:12-124).
- [ ] [Area: refactor] [Impact: P2] [Effort: M] Replace hard-coded first:500 GraphQL fetches with pagination — multiple queries pull up to 500 records, risking truncation and bloated HTML; introduce pagination or segmented feeds (src/pages/libri/index/_graphql.ts:15-22, src/pages/sitemap.xml/_graphql.ts:4-24, src/pages/staff/archivio-catalogo/_graphql.ts:1-25).
- [ ] [Area: infra] [Impact: P2] [Effort: S] Stop running schema generation automatically on install — prepare.mjs always executes npm run generate-schema, which fails without CMA tokens and breaks onboarding; gate the call or reuse scripts/generate-schema.mjs (scripts/prepare.mjs:36-68, package.json:18).
- [ ] [Area: refactor] [Impact: P3] [Effort: S] Prune unused runtime adapters — @astrojs/cloudflare and @astrojs/node are dependencies but unused in astro.config, adding supply-chain and install overhead (package.json:20-24).
- [ ] [Area: testing] [Impact: P3] [Effort: M] Introduce automated checks — project lacks CI to run astro check/build/lint despite scripts existing; add a workflow to catch regressions before deploy (package.json:7-23).
